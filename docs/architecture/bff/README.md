<h1 align="center">Backend for Frontend</h1>

## ❯ Introduction

The Backend for Frontend (BFF) design pattern is an architectural approach that a browser-based application can use to 
handle all of its authentication and authorisation responsibilities and API interactions, for example:

- The BFF interacts with an OAuth 2.0 Authorization Server as a confidential OAuth 2.0 Client.
- The BFF manages OAuth 2.0 access and refresh tokens in the context of a cookie-based session, avoiding the direct exposure of any tokens to the browser-based application.
- The BFF forwards all requests to a OAuth 2.0 Resource Server, augmenting them with the correct access token before forwarding them to the resource server.

The [OAuth 2.0 for Browser-Based Applications](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-browser-based-apps) 
specification outlines the threats, attack consequences, security considerations and best practices that must be taken 
into account when developing browser-based applications. It also discusses how different architectural approaches can 
help address some of these challenges.

## ❯ Application Architecture

A user launches Serendipity's Progressive Web App ([PWA](.././pwa/README.md)) which is [loaded](.././static-content/README.md) 
and then runs in the web browser (user agent).

The PWA checks with the BFF to see if there is an active session by calling a "check session" API endpoint.

When no active session is found, the PWA triggers a navigation to the BFF to initiate the Authorization Code flow with 
the PKCE extension, to which the BFF responds by redirecting the browser to the authorization endpoint. 

When the user is redirected back, the browser delivers the authorization code to the BFF, the BFF can then exchange it 
for tokens at the token endpoint using its client credentials and PKCE code verifier.

The BFF associates the obtained tokens with the user's session and sets a cookie in the response to keep track of this 
session. At this point, the redirect-based Authorization Code flow has been completed, so the BFF can hand control back 
to the PWA.

When the PWA wants to make a request to the resource server, it sends a request to the corresponding endpoint on the BFF. 
This request includes a cookie, allowing the BFF to obtain the proper tokens for this user's session. The BFF removes the 
cookie from the request, attaches the user's access token to the request, and forwards it to the actual resource server. 

The Backend for Frontend then forwards the response back to the Progressive Web App.

### Implementation

We’ll use Spring's [Cloud Gateway](https://spring.io/projects/spring-cloud-gateway) to implement the Backend for Frontend design pattern.

Spring Cloud Gateway Server Web MVC can leverage lightweight threads (introduced in Java 21), to enhance its scalability and performance.

### Spring Initializr

We'll use [Spring Initializr](https://start.spring.io/) to bootstrap the Backend for Frontend.

For example:

```
Project: Maven
Language: Java
Spring Boot: 3.5.5
Group: org.serendipity
Artifact: web-bff
Name: Serendipity Web BFF
Description: The Backend for Frontend for Serendipitys Progressive Web App.
Package name: org.serendipity.webbff
Packaging: Jar
Java: 21
```

**Dependencies**

Gateway (Spring Cloud Routing): Provides a simple, yet effective way to route to APIs in Servlet-based applications. 
Provides cross-cutting concerns to those APIs such as security, monitoring/metrics, and resiliency.

OAuth2 Client (Security): Spring Boot integration for Spring Security's OAuth2/OpenID Connect client features.

### Multi Module Project

A Maven multi-module project with Spring Boot refers to a project structure where a large application is broken down 
into smaller, independent modules, all managed under a single parent Maven project. This approach offers several 
benefits for developing scalable and maintainable Spring Boot applications.

For example:

```
 ├── /serendipity
     └── /backend
         ├── pom.xml (Parent POM)
         └── /modules
            └── /web-bff
                ├── pom.xml
            └── /party-service
                ├── pom.xml                
```

Parent POM: This acts as an aggregator, defining common dependencies, plugin configurations, and properties shared across all 
submodules. Its `pom.xml` file has a packaging type of pom and lists the submodules in a <modules> section.

Submodules: Each submodule represents a distinct component or layer of the application (e.g., web, service, repository, domain). 
These are regular Maven projects with their own pom.xml files, which inherit from the parent project using the <parent> tag.

Unzip the zip file (web-bff.zip) generated by Spring Initializr in the `/modules` directory.

Create a Parent POM in the `/backend` directory.

### Application Properties

Convert the BFF's `application.properties` to yaml.

## ❯ References

* Spring Cloud Gateway docs: [Spring Cloud Gateway Server MVC](https://docs.spring.io/spring-cloud-gateway/reference/spring-cloud-gateway-server-mvc.html)